---
phase: 01-oauth-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - components/calendar/ConnectionStatus.tsx
  - app/dashboard/page.tsx
  - app/settings/page.tsx
  - app/settings/calendar/page.tsx
  - components/dashboard/DashboardHeader.tsx
  - lib/supabase/queries.ts
autonomous: true

must_haves:
  truths:
    - "User can see Google Calendar connection status in the dashboard header"
    - "User can see connection status on a settings page"
    - "User can disconnect Google Calendar from settings with confirmation dialog"
    - "Disconnect warns about consequences (workouts will stop syncing)"
    - "User can reconnect Google Calendar from settings after disconnect or initial skip"
    - "Connection status shows error state when tokens are invalid"
  artifacts:
    - path: "components/calendar/ConnectionStatus.tsx"
      provides: "Reusable connection status indicator component"
      min_lines: 40
    - path: "app/settings/page.tsx"
      provides: "Settings page with calendar connection section"
      min_lines: 30
    - path: "app/settings/calendar/page.tsx"
      provides: "Calendar settings page with connect/disconnect/change calendar"
      min_lines: 60
  key_links:
    - from: "components/calendar/ConnectionStatus.tsx"
      to: "lib/supabase/queries.ts"
      via: "receives integration data as props (fetched by parent)"
      pattern: "is_active|last_sync_status"
    - from: "app/dashboard/page.tsx"
      to: "components/calendar/ConnectionStatus.tsx"
      via: "renders ConnectionStatus in dashboard header area"
      pattern: "ConnectionStatus"
    - from: "app/settings/calendar/page.tsx"
      to: "/api/auth/google/authorize"
      via: "connect button links to OAuth flow"
      pattern: "/api/auth/google/authorize"
    - from: "app/settings/calendar/page.tsx"
      to: "app/actions/calendar/tokens.ts"
      via: "disconnect calls deleteGoogleTokens"
      pattern: "deleteGoogleTokens"
---

<objective>
Build Google Calendar connection status indicators across the app and a settings page for managing the calendar connection.

Purpose: Per user decisions, connection status must be visible in the dashboard header/nav, settings page, and workout calendar view. Users need to disconnect with consequences warning and reconnect from settings. This delivers the status visibility locked decisions and provides the settings-based connection path for users who skipped during onboarding.

Output: Reusable ConnectionStatus component, settings pages with connect/disconnect/change calendar, updated dashboard with status indicator.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-oauth-foundation/01-CONTEXT.md
@.planning/phases/01-oauth-foundation/01-02-SUMMARY.md

@app/dashboard/page.tsx
@components/dashboard/DashboardHeader.tsx
@lib/supabase/queries.ts
@lib/supabase/auth.ts
@types/database.ts
@components/ui/button.tsx
@components/ui/card.tsx
@components/ui/dialog.tsx
@components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectionStatus component and add integration query helper</name>
  <files>components/calendar/ConnectionStatus.tsx, lib/supabase/queries.ts</files>
  <action>
    **Add to `lib/supabase/queries.ts`:**

    Add a new exported function `getGoogleCalendarIntegration(userId: string, supabaseClient?: SupabaseClient)`:
    1. Query integrations table: select id, provider, calendar_id, is_active, last_sync_at, last_sync_status, last_sync_error, token_expires_at where user_id=userId and provider='google_calendar'
    2. Use .maybeSingle() (not .single()) since integration may not exist
    3. Return the row or null
    4. Do NOT return access_token or refresh_token fields (those are Vault UUIDs and should never reach the client)

    Also add `getCalendarDisplayName(userId: string, supabaseClient?: SupabaseClient)`:
    1. Get integration record
    2. Return calendar_id or null (the display name will be handled by the component)

    **Create `components/calendar/ConnectionStatus.tsx`** ('use client' directive):

    Props interface:
    ```typescript
    interface ConnectionStatusProps {
      integration: {
        is_active: boolean;
        last_sync_status: string | null;
        last_sync_error: string | null;
        calendar_id: string | null;
      } | null;
      variant?: 'compact' | 'detailed';  // compact for header, detailed for settings
      className?: string;
    }
    ```

    **Compact variant** (for dashboard header):
    - Connected + active: Green dot + "Calendar Connected" text (or just green dot icon if space is tight)
    - Disconnected / no integration: Gray dot + "Calendar Not Connected" text
    - Error / needs_reconnection: Red/amber dot + "Calendar Error" text
    - Use shadcn Badge component with appropriate variant (default, secondary, destructive, outline)
    - Use lucide-react icons: CheckCircle2 (green), XCircle (red), AlertCircle (amber), Calendar (gray)

    **Detailed variant** (for settings page):
    - Shows same status but with more detail
    - Connected: Shows calendar name (calendar_id), last sync time, green status
    - Error: Shows error message from last_sync_error, amber/red status, "Reconnect" suggestion
    - Not connected: Shows "Connect Google Calendar" call to action

    Style with Tailwind. Use existing color patterns from the codebase (text-green-600, text-red-600, text-amber-600, etc.). Support dark mode (dark: variants).

    IMPORTANT per user decisions:
    - Status indicator changes color based on state (icon turns red/warning color with error text)
    - Locations: dashboard header, settings page, workout calendar view
  </action>
  <verify>
    Run `npx tsc --noEmit`. Verify ConnectionStatus renders both variants. Verify getGoogleCalendarIntegration query exists and does NOT expose token fields.
  </verify>
  <done>
    ConnectionStatus component exists with compact and detailed variants. Integration query helper added to queries.ts. No token data exposed to client components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create settings pages and integrate status into dashboard</name>
  <files>app/settings/page.tsx, app/settings/calendar/page.tsx, app/dashboard/page.tsx, components/dashboard/DashboardHeader.tsx</files>
  <action>
    **Create `app/settings/page.tsx`** (Server Component):
    1. Import requireAuth, getSupabaseClient, getProfile, getGoogleCalendarIntegration
    2. Verify auth, get profile and integration
    3. Render a simple settings page with sections:
       - Header: "Settings" with user info
       - "Google Calendar" card section showing ConnectionStatus (detailed variant)
       - Link to `/settings/calendar` for "Manage Calendar Connection"
       - Leave room for future settings sections (placeholder comment)
    4. Use Card, CardHeader, CardContent layout. Follow the dashboard styling pattern.
    5. Include a Back to Dashboard link.

    **Create `app/settings/calendar/page.tsx`** ('use client' with server data passed via searchParams or fetched client-side):

    Actually, make this a Server Component that fetches data and passes to a client child:

    Create `app/settings/calendar/page.tsx` as Server Component:
    1. Fetch integration data via getGoogleCalendarIntegration
    2. Pass to CalendarSettings client component

    Create `components/calendar/CalendarSettings.tsx` ('use client'):

    Props: integration data (same shape as ConnectionStatus but full record)

    **If NOT connected:**
    - Show "Connect Google Calendar" section with permissions explanation (same as onboarding but condensed)
    - "Connect" Button links to `/api/auth/google/authorize?redirect=/settings/calendar` (redirect param tells callback where to go after)
    - No disconnect option shown

    **If connected:**
    - Show ConnectionStatus (detailed variant) at top
    - Show "Connected Calendar" section with calendar_id displayed
    - Show "Change Calendar" section: could link to a calendar selection flow (reuse calendar selection from Plan 03's Server Actions). For now, show "Change Calendar" button that expands to show calendar list dropdown + save button.
    - Show "Disconnect" section at bottom with red-toned card:
      - Warning text: "Disconnecting will stop workout sync to Google Calendar. Existing calendar events will remain but no new workouts will be synced."
      - "Disconnect Google Calendar" destructive Button
      - On click, show confirmation Dialog (shadcn):
        - Title: "Disconnect Google Calendar?"
        - Description: "Your workouts will stop syncing to Google Calendar. Existing events in your calendar will not be removed. You can reconnect anytime."
        - Cancel + "Disconnect" (destructive) buttons
      - On confirm: call deleteGoogleTokens Server Action, then refresh page

    **Update `app/dashboard/page.tsx`:**
    1. Import getGoogleCalendarIntegration
    2. After fetching profile, also fetch integration: `const integration = await getGoogleCalendarIntegration(user.id, supabase);`
    3. Pass integration data to DashboardHeader (or render ConnectionStatus directly)

    **Update `components/dashboard/DashboardHeader.tsx`:**
    1. Accept optional `calendarStatus` prop with integration data shape
    2. Render ConnectionStatus (compact variant) in the header, aligned right or below the week info
    3. Make it a link to `/settings/calendar` so users can click to manage
    4. If no calendarStatus prop provided, don't render anything (backward compatible)

    Follow existing patterns in dashboard: Server Component fetches data, passes to client components as props.

    IMPORTANT per user decisions:
    - Disconnect option: Yes, with both confirmation AND consequences warning
    - Status visible in dashboard header/nav and settings page
    - Users who skipped can connect from settings
  </action>
  <verify>
    Run `npx tsc --noEmit`. Verify:
    - Settings pages exist and render
    - Dashboard shows ConnectionStatus
    - DashboardHeader accepts optional calendarStatus prop
    - Disconnect has confirmation dialog with consequences warning
    - Connect from settings links to OAuth flow with redirect
  </verify>
  <done>
    Settings pages created with full connect/disconnect/change calendar functionality. Dashboard header shows compact connection status indicator. Disconnect has confirmation dialog with consequences warning per user decision. Settings provides connect path for users who skipped onboarding calendar step.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Dashboard header shows calendar connection status (green/gray/red indicator)
3. Settings page exists at /settings with calendar section
4. Calendar settings page at /settings/calendar shows full management UI
5. Disconnect flow has confirmation dialog with warning text
6. Connect from settings redirects to OAuth then back to settings
7. ConnectionStatus component supports both compact and detailed variants
</verification>

<success_criteria>
- Connection status visible in dashboard header (locked decision)
- Connection status visible on settings page (locked decision)
- Disconnect with confirmation AND consequences warning (locked decision)
- Error states show visual indicator change (icon turns red/warning - locked decision)
- Users who skipped onboarding can connect from settings (locked decision)
- No token data exposed to client components (DATA-03 compliance)
</success_criteria>

<output>
After completion, create `.planning/phases/01-oauth-foundation/01-04-SUMMARY.md`
</output>
