---
phase: 01-oauth-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/005_vault_setup.sql
  - supabase/migrations/006_update_integrations_for_vault.sql
  - types/database.ts
autonomous: true
user_setup:
  - service: google_cloud
    why: "OAuth credentials for Google Calendar API"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized redirect URI: http://localhost:3000/api/auth/google/callback"
        location: "Google Cloud Console -> OAuth Client -> Authorized redirect URIs"
      - task: "Enable Google Calendar API"
        location: "Google Cloud Console -> APIs & Services -> Library -> Google Calendar API"
  - service: supabase
    why: "Enable Vault extension for encrypted token storage"
    env_vars: []
    dashboard_config:
      - task: "Enable pgsodium and vault extensions"
        location: "Supabase Dashboard -> Database -> Extensions -> search 'vault' -> Enable"

must_haves:
  truths:
    - "Supabase Vault extension is enabled and RPC wrapper functions exist for creating, retrieving, and updating secrets"
    - "integrations table stores Vault secret UUIDs in access_token/refresh_token columns instead of plaintext tokens"
    - "TypeScript types reflect the integration model with Vault-based token storage"
    - "workouts table has timezone column storing IANA timezone names"
  artifacts:
    - path: "supabase/migrations/005_vault_setup.sql"
      provides: "Vault extension enablement and RPC wrapper functions"
      contains: "vault.create_secret"
    - path: "supabase/migrations/006_update_integrations_for_vault.sql"
      provides: "Updated integrations table documentation and timezone column on workouts"
      contains: "timezone"
    - path: "types/database.ts"
      provides: "Updated Integration type with Vault-aware fields and workout timezone"
      contains: "IntegrationProvider"
  key_links:
    - from: "supabase/migrations/005_vault_setup.sql"
      to: "vault extension"
      via: "CREATE EXTENSION"
      pattern: "CREATE EXTENSION.*vault"
---

<objective>
Set up Supabase Vault for encrypted OAuth token storage and add IANA timezone support to the data model.

Purpose: All subsequent OAuth plans depend on Vault being available for secure token storage. The integrations table already exists but currently stores tokens as plaintext TEXT columns. We need Vault RPC wrapper functions so OAuth tokens can be encrypted at rest per DATA-03. We also need timezone columns on workouts for DATA-01.

Output: Two SQL migrations (Vault setup + schema updates), updated TypeScript types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-oauth-foundation/01-RESEARCH.md

@types/database.ts
@supabase/migrations/001_schema.sql
@lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vault extension and RPC wrapper migrations</name>
  <files>supabase/migrations/005_vault_setup.sql, supabase/migrations/006_update_integrations_for_vault.sql</files>
  <action>
    Create `supabase/migrations/005_vault_setup.sql`:
    1. Enable the vault extension: `CREATE EXTENSION IF NOT EXISTS "vault" WITH SCHEMA "vault";`
    2. Enable supabase_vault schema access (Vault uses its own schema).
    3. Create RPC wrapper function `vault_create_secret(secret TEXT, name TEXT, description TEXT DEFAULT NULL) RETURNS UUID` with SECURITY DEFINER that calls `vault.create_secret()`. Include auth.uid() check to ensure only authenticated users can call it.
    4. Create RPC wrapper function `vault_read_secret(secret_id UUID) RETURNS TEXT` with SECURITY DEFINER that reads from `vault.decrypted_secrets` view by ID. Include auth.uid() check.
    5. Create RPC wrapper function `vault_update_secret(secret_id UUID, new_secret TEXT, new_name TEXT DEFAULT NULL) RETURNS VOID` with SECURITY DEFINER that calls `vault.update_secret()`. Include auth.uid() check.
    6. Create RPC wrapper function `vault_delete_secret(secret_id UUID) RETURNS VOID` with SECURITY DEFINER. Include auth.uid() check.
    7. Grant EXECUTE permissions on all functions to `authenticated` role.

    Create `supabase/migrations/006_update_integrations_for_vault.sql`:
    1. Add `timezone VARCHAR(50)` column to `workouts` table with DEFAULT 'UTC'. This stores the IANA timezone name for each workout (DATA-01). Add a comment explaining this stores the user's timezone at time of workout creation so DST transitions don't shift scheduled times.
    2. Add an index on `workouts(timezone)` for timezone-based queries.
    3. Add a comment on `integrations.access_token` and `integrations.refresh_token` clarifying they store Vault secret UUIDs (not plaintext tokens) after Phase 1 migration. The column type remains TEXT to store UUID strings.
    4. Do NOT alter the integrations table columns since they already exist with the right types. The semantics change from "plaintext token" to "Vault secret UUID" is handled at the application level.

    IMPORTANT: These migrations will be run via the existing `scripts/run-migrations.js` runner. Follow the existing numbered naming convention (001, 002, etc.).
  </action>
  <verify>
    Read both migration files and verify:
    - Vault extension creation is present
    - All 4 RPC functions (create, read, update, delete) exist with SECURITY DEFINER
    - auth.uid() checks in all functions
    - workouts.timezone column with IANA default
    - No destructive changes to existing tables
  </verify>
  <done>
    Two migration files exist with correct SQL. Vault RPC functions are callable by authenticated users. Workouts table gains timezone column.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types for Vault-based token storage and workout timezone</name>
  <files>types/database.ts</files>
  <action>
    Update `types/database.ts`:

    1. Add `timezone?: string` field to both `Workout` interface (after `phase` field) and `WorkoutRow` interface (as `timezone: string | null`). This stores the IANA timezone name (e.g., 'America/New_York') for DATA-01.

    2. Add a `SyncStatus` type: `export type SyncStatus = 'connected' | 'disconnected' | 'error' | 'needs_reconnection';`

    3. Update the `Integration` interface's `access_token` and `refresh_token` field comments to clarify these store Vault secret UUIDs (not actual tokens) when provider is 'google_calendar'. Add a JSDoc comment above each field.

    4. Add a `GoogleCalendarIntegration` convenience type that narrows Integration for google_calendar provider:
    ```typescript
    export interface GoogleCalendarIntegration extends Omit<Integration, 'provider'> {
      provider: 'google_calendar';
      access_token_vault_id?: string;  // Vault UUID for encrypted access token
      refresh_token_vault_id?: string; // Vault UUID for encrypted refresh token
    }
    ```

    5. Keep all existing types untouched. Only add new types and modify the Workout/WorkoutRow interfaces to add the timezone field.

    IMPORTANT: Do NOT remove the existing `google_access_token`, `google_refresh_token`, `google_calendar_id` fields from the `Profile` interface. Those are used by the legacy combined type and will be updated in a later plan when we refactor the profile queries.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors are introduced. Check that existing code still compiles.
  </verify>
  <done>
    TypeScript types compile without errors. Workout interfaces have timezone field. SyncStatus type exists. GoogleCalendarIntegration convenience type exists.
  </done>
</task>

</tasks>

<verification>
1. Both migration SQL files exist in `supabase/migrations/` with correct numbering
2. `npx tsc --noEmit` passes with no errors
3. Migration files contain all 4 Vault RPC wrapper functions
4. Workouts timezone column defaults to 'UTC'
5. No existing functionality is broken
</verification>

<success_criteria>
- Vault extension SQL migration ready to run
- 4 RPC wrapper functions (create, read, update, delete) defined with security checks
- Workouts table gets IANA timezone column (DATA-01 foundation)
- TypeScript types updated for Vault-aware integration and workout timezone
- All existing code still compiles
</success_criteria>

<output>
After completion, create `.planning/phases/01-oauth-foundation/01-01-SUMMARY.md`
</output>
