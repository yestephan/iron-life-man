---
phase: 01-oauth-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - app/actions/calendar/calendars.ts
  - lib/google/calendar-client.ts
  - app/onboarding/calendar-connect/page.tsx
  - app/onboarding/availability/page.tsx
  - app/onboarding/generating/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a permissions explanation before being sent to Google OAuth"
    - "User can skip calendar connection during onboarding and proceed to plan generation"
    - "After OAuth approval, user sees a dropdown of their writable calendars"
    - "User can create a dedicated 'Iron Life Man' calendar which is pre-selected as default"
    - "User can select any writable calendar from the dropdown and continue"
    - "Calendar selection is saved to the integrations table"
    - "Onboarding flow correctly routes: availability -> calendar-connect -> generating"
  artifacts:
    - path: "app/onboarding/calendar-connect/page.tsx"
      provides: "Two-step calendar connection page (permissions + selection)"
      min_lines: 80
    - path: "app/actions/calendar/calendars.ts"
      provides: "Server Actions for calendar list, create, and select"
      exports: ["listWritableCalendars", "createIronLifeManCalendar", "selectCalendar"]
    - path: "lib/google/calendar-client.ts"
      provides: "Authenticated Google Calendar API client factory"
      exports: ["getCalendarClient"]
  key_links:
    - from: "app/onboarding/calendar-connect/page.tsx"
      to: "/api/auth/google/authorize"
      via: "Button link to initiate OAuth"
      pattern: "/api/auth/google/authorize"
    - from: "app/onboarding/calendar-connect/page.tsx"
      to: "app/actions/calendar/calendars.ts"
      via: "calls listWritableCalendars, createIronLifeManCalendar, selectCalendar"
      pattern: "listWritableCalendars|createIronLifeManCalendar|selectCalendar"
    - from: "app/actions/calendar/calendars.ts"
      to: "lib/google/calendar-client.ts"
      via: "uses getCalendarClient for Google API calls"
      pattern: "getCalendarClient"
    - from: "app/onboarding/availability/page.tsx"
      to: "app/onboarding/calendar-connect/page.tsx"
      via: "router.push navigation after availability step"
      pattern: "calendar-connect"
---

<objective>
Build the calendar selection Server Actions and the calendar-connect onboarding page with skip support.

Purpose: This delivers GCAL-02 (calendar selection during setup). Users need to see their writable Google Calendars after OAuth, create a dedicated "Iron Life Man" calendar, and select which calendar to use. The page integrates into the existing onboarding flow between availability and plan generation, per user decisions. Skip is fully supported -- no nagging.

Output: Calendar Server Actions, Calendar client factory, calendar-connect onboarding page, updated flow routing in availability and generating pages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-oauth-foundation/01-CONTEXT.md
@.planning/phases/01-oauth-foundation/01-RESEARCH.md
@.planning/phases/01-oauth-foundation/01-02-SUMMARY.md

@app/onboarding/availability/page.tsx
@app/onboarding/generating/page.tsx
@app/onboarding/layout.tsx
@lib/supabase/auth.ts
@lib/supabase/server.ts
@types/database.ts
@components/ui/button.tsx
@components/ui/card.tsx
@components/ui/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create calendar client factory and calendar Server Actions</name>
  <files>lib/google/calendar-client.ts, app/actions/calendar/calendars.ts</files>
  <action>
    **Create `lib/google/calendar-client.ts`:**

    Export `async getCalendarClient(userId: string)`:
    1. Import `google` from 'googleapis' and `createAuthenticatedClient` from './oauth-client'
    2. Call createAuthenticatedClient(userId) to get OAuth2Client with user's tokens
    3. Return `google.calendar({ version: 'v3', auth })` -- the Calendar v3 API client

    **Create `app/actions/calendar/calendars.ts`** ('use server' directive):

    Import getCalendarClient from '@/lib/google/calendar-client' and createClient from '@/lib/supabase/server'.

    **listWritableCalendars(userId: string): Promise<Array<{ id: string; summary: string; primary: boolean; backgroundColor?: string }>>**
    1. Get calendar client via getCalendarClient(userId)
    2. Call `calendar.calendarList.list({ minAccessRole: 'writer', showDeleted: false, showHidden: false })`
    3. Map results to return id, summary, primary (boolean), backgroundColor
    4. Return empty array if no items
    5. Handle errors: if token is invalid (401), throw with descriptive message "Calendar connection expired. Please reconnect."

    **createIronLifeManCalendar(userId: string): Promise<{ id: string; summary: string }>**
    1. Get calendar client and Supabase client
    2. Fetch user's timezone from user_profiles table: `select('timezone').eq('id', userId).single()`
    3. Use timezone or default to Intl.DateTimeFormat().resolvedOptions().timeZone (fallback: 'America/New_York')
    4. Call `calendar.calendars.insert({ requestBody: { summary: 'Iron Life Man', description: 'Triathlon training workouts managed by Iron Life Man', timeZone: timezone } })`
    5. Return { id: data.id!, summary: data.summary! }
    6. CRITICAL per research pitfall #6: Always set timeZone when creating calendar, never leave it as UTC default

    **selectCalendar(userId: string, calendarId: string): Promise<void>**
    1. Get Supabase client
    2. Update integrations table: set calendar_id=calendarId, updated_at=now() where user_id=userId and provider='google_calendar'
    3. If no row updated, throw error "No Google Calendar integration found. Please connect first."
  </action>
  <verify>
    Run `npx tsc --noEmit`. Verify all three functions are exported. Verify minAccessRole='writer' is used in listWritableCalendars.
  </verify>
  <done>
    Calendar client factory and 3 Server Actions created. listWritableCalendars filters for writable only. createIronLifeManCalendar uses user's IANA timezone. selectCalendar updates integration record.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create calendar-connect onboarding page and update flow routing</name>
  <files>app/onboarding/calendar-connect/page.tsx, app/onboarding/availability/page.tsx, app/onboarding/generating/page.tsx</files>
  <action>
    **Create `app/onboarding/calendar-connect/page.tsx`** ('use client' directive):

    This is a two-step page controlled by URL searchParams:
    - Default (no step param): Shows permissions explanation + "Connect Google Calendar" button + "Skip for Now" button
    - step=select: Shows calendar dropdown + "Create Iron Life Man Calendar" button + Continue/Skip buttons
    - skipped=true: Shows brief "No problem" message then auto-redirects to generating (or user can go back)
    - error=invalid_state|token_exchange|missing_code: Shows error alert with retry option

    **Step 1 - Connect (default view):**
    1. Display heading: "Connect Google Calendar" with description "Sync your workouts to Google Calendar automatically"
    2. Show permissions card with shadcn Card component:
       - "What we'll access:" section with bullet points:
         - "View your calendar list" (Calendar icon)
         - "Create and manage workout events" (CalendarPlus icon)
         - "Update events when your plan changes" (RefreshCw icon)
       - Footer text: "We'll only access your Google Calendar. No other data is read or stored."
    3. "Connect Google Calendar" primary Button as an `<a href="/api/auth/google/authorize">` (triggers OAuth)
    4. "Skip for Now" outline Button that calls router.push() to pass through to generating page with all existing search params
    5. If error param exists, show Alert with variant="destructive" and appropriate message

    **Step 2 - Select Calendar (step=select):**
    1. On mount, call listWritableCalendars() Server Action. Show loading spinner while fetching.
    2. Display "Choose Your Calendar" heading with description "Select where your workouts will appear"
    3. Show "Create 'Iron Life Man' Calendar (Recommended)" Button at top. When clicked:
       - Set loading state
       - Call createIronLifeManCalendar() Server Action
       - Add new calendar to list and auto-select it
       - Show success toast
    4. Below that, show shadcn Select dropdown with all writable calendars. Each option shows calendar summary and "(Primary)" label if primary.
    5. "Continue" primary Button (disabled until calendar selected). When clicked:
       - Call selectCalendar() Server Action
       - Navigate to generating page with all onboarding params
    6. "Skip for Now" outline Button that navigates to generating page without selecting

    **Routing and params handling:**
    - The page must forward all onboarding search params (raceDate, fitnessLevel, targetHours, weekdayTime, weekendTime, timezone) when navigating to generating page
    - Read these params from searchParams and include them in all navigation

    **Update `app/onboarding/availability/page.tsx`:**
    - Change the handleSubmit navigation from `router.push('/onboarding/generating?${params.toString()}')` to `router.push('/onboarding/calendar-connect?${params.toString()}')`
    - This inserts the calendar-connect step between availability and generating

    **Update `app/onboarding/generating/page.tsx`:**
    - No changes needed to the generating page itself. It already reads all params from searchParams.
    - The calendar-connect page forwards all params when navigating to generating.

    Use shadcn/ui components: Button, Card (CardHeader, CardContent, CardDescription, CardTitle), Alert (AlertDescription), Select (SelectTrigger, SelectValue, SelectContent, SelectItem). Use lucide-react icons: Calendar, CalendarPlus, RefreshCw, Check, Loader2.

    Follow existing onboarding page patterns: centered card layout, consistent spacing (space-y-6), Back/Continue button pattern.

    IMPORTANT user decisions:
    - Optional with skip. No repeated prompts after skip.
    - Show permissions before OAuth redirect (transparency).
    - Dropdown list for calendar selection.
    - Create dedicated "Iron Life Man" calendar and pre-select it.
    - OAuth denial/cancel treated same as skip.
  </action>
  <verify>
    Run `npx tsc --noEmit`. Verify:
    - calendar-connect page renders without errors
    - availability page now routes to calendar-connect instead of generating
    - Both "connect" and "select" views exist based on step param
    - Skip buttons navigate to generating page with all onboarding params preserved
    - Permissions card is shown before OAuth redirect
  </verify>
  <done>
    Calendar-connect page exists with two-step flow (permissions -> selection). Availability routes to calendar-connect. Skip works in both steps. "Iron Life Man" calendar creation works. Calendar selection saves to integration record. All onboarding params preserved through the flow.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Onboarding flow: availability -> calendar-connect -> generating
3. Can skip at any point and still reach generating
4. Calendar dropdown shows only writable calendars
5. "Iron Life Man" calendar creation uses user's IANA timezone
6. Selected calendar ID saved to integrations table
7. Error states (invalid_state, token_exchange) show user-friendly messages
</verification>

<success_criteria>
- GCAL-02: User can select which calendar to write workouts to during setup
- User can create "Iron Life Man" calendar as default (locked decision)
- Calendar connection is optional during onboarding (locked decision)
- Only writable calendars shown in dropdown (locked decision)
- Permissions shown before OAuth redirect (locked decision)
- Skip/denial treated gracefully, available in settings later (locked decision)
</success_criteria>

<output>
After completion, create `.planning/phases/01-oauth-foundation/01-03-SUMMARY.md`
</output>
